function app_init(){advanced_mode_set("true"==settings.get("advmode","false")?!0:!1)}function updateStatusCallback(a){console.log("response from fb login",a),"connected"===a.status?(uid=a.authResponse.userID,accessToken=a.authResponse.accessToken,FB.api("/me",function(a){console.log("fb_user",a.name+"-"+uid),_gaq.push(["_trackEvent","wheretheynow","loggedin",a.name+"-"+uid])}),$("#auth_button").hide(),async.series([fb_check_permissions,fb_get_data])):"not_authorized"===a.status&&$("#auth_button").show()}function fb_authorise(){permissions.scope=advanced_mode?basic_permissions.scope+", "+advanced_permissions.scope:basic_permissions.scope,FB.login(function(a){console.log("login response",a),a.authResponse?(console.log("Welcome!  Fetching your information.... "),fb_init_get_data()):console.log("User cancelled login or did not fully authorize.")},permissions)}function fb_init_get_data(){mapTitlesToFields={},counts={locations:{current_location:0,current_address:0,hometown_location:0},sex:{},relationship_status:{},taxonomy:{},online:{yes:0,no:0},hidden_friends:[]},data={},friendlists={},friendsinfriendlists={},$("#controls select:not(#which_location) option:not(:first-child)").remove(),$("#taxonomy>ul>li").remove(),FB.getLoginStatus(updateStatusCallback)}function fb_check_permissions(a){console.log("fb_check_permissions"),permissions.scope=advanced_mode?basic_permissions.scope+", "+advanced_permissions.scope:basic_permissions.scope;var b="SELECT "+permissions.scope+" FROM permissions WHERE uid=me()";console.log(b);var c=!1;FB.api("/fql",{q:b,access_token:accessToken},function(b){console.log(b);for(var d in b.data[0]){var e=b.data[0][d];if(console.log("permission",e),!e){c=!0;break}}console.log("permission_needed",c),c?($("#auth_button .new").hide(),$("#auth_button .update").show(),$("#auth_button").show()):a()})}function fb_get_data(){if($("#loading").show(),advanced_mode)var a="select uid, name, pic_square, activities, affiliations, books, current_address, current_location, education, hometown_location, inspirational_people, interests, languages, meeting_for, meeting_sex, movies, music, online_presence, political, profile_url, relationship_status, religion, sex, sports, tv, work from user where uid in (select uid2 from friend where uid1 = me())";else var a="select uid, name, pic_square, current_location, current_address, hometown_location, relationship_status, sex, profile_url from user where uid in (select uid2 from friend where uid1 = me())";FB.api("/fql",{q:a,access_token:accessToken},function(a){console.log(a),data=a.data,map_process_data(),map_update()});var a="select count, flid, name, type from friendlist where owner = me()";FB.api("/fql",{q:a,access_token:accessToken},function(a){console.log(a),friendlists=a.data;var b=$("#list");for(var c in friendlists){var d=friendlists[c];$(b).append('<option value="'+d.flid+'">'+d.name+" - "+d.count+"</option>")}});var a="select flid, uid from friendlist_member where flid in (select flid from friendlist  where owner = me())";FB.api("/fql",{q:a,access_token:accessToken},function(a){console.log(a);for(var b in a.data){var c=a.data[b];friendsinfriendlists[""+c.flid]||(friendsinfriendlists[""+c.flid]={}),friendsinfriendlists[""+c.flid][""+c.uid]=1}console.log("fifl",friendsinfriendlists)})}function getSubField(a,b){if(!a)return"Doesn't say";if(1==b.length)return a[b[0]];var c=b[0];return b=b.splice(1,99),getSubField(a[c],b)}function setSubField(a,b,c){if(1==b.length)a[b[0]]=c;else{var d=b[0];a[d]||(a[d]={}),b=b.splice(1,99),setSubField(a[d],b,c)}}function addStringtoTaxonomy(a,b,c){mapTitlesToFields[a]={type:"string",field_name:c},b[c]=null!=b[c]&&void 0!=b[c]&&b[c].length>0?b[c].split(","):["Doesn't say"],counts.taxonomy[a]||(counts.taxonomy[a]={});for(var d in b[c])counts.taxonomy[a][b[c][d]]||(counts.taxonomy[a][b[c][d]]=0),counts.taxonomy[a][b[c][d]]++}function addArraytoTaxonomy(a,b,c,d){mapTitlesToFields[a]={type:"array",field_name:c,sub_field:d},(null==b[c]||void 0==b[c]||0==b[c].length)&&(d?(b[c]=[{}],setSubField(b[c][0],d.split("."),"Doesn't say")):b[c]=["Doesn't say"]),counts.taxonomy[a]||(counts.taxonomy[a]={});for(var e in b[c]){if(d)var f=getSubField(b[c][e],d.split("."));else var f=b[c][e];counts.taxonomy[a][f]||(counts.taxonomy[a][f]=0),counts.taxonomy[a][f]++}}function map_process_data(){function b(a){var b='<div class="profile_window"><a href="'+a.profile_url+'" target="_blank" title="click to visit profile">';return b+='<span class="field name">'+a.name+"</span>",b+='<span class="field pic"><img src="'+a.pic_square+'" /></span>',b+="</a></div>"}$("#loading").hide();var a;for(var c in data)a=data[c],a.current_location&&(counts.locations.current_location++,a.current_location.marker=new google.maps.Marker({icon:"https://maps.google.com/mapfiles/ms/icons/blue-dot.png",position:new google.maps.LatLng(a.current_location.latitude,a.current_location.longitude),title:a.name}),google.maps.event.addListener(a.current_location.marker,"click",function(a){return function(){infowindow.setContent(b(a)),infowindow.open(map,a.current_location.marker)}}(a))),a.current_address&&(counts.locations.current_address++,a.current_address.marker=new google.maps.Marker({icon:"https://maps.google.com/mapfiles/ms/icons/blue-dot.png",position:new google.maps.LatLng(a.current_address.latitude,a.current_address.longitude),title:a.name}),google.maps.event.addListener(a.current_address.marker,"click",function(a){return function(){infowindow.setContent(b(a)),infowindow.open(map,a.current_address.marker)}}(a))),a.hometown_location&&(counts.locations.hometown_location++,a.hometown_location.marker=new google.maps.Marker({icon:"https://maps.google.com/mapfiles/ms/icons/blue-dot.png",position:new google.maps.LatLng(a.hometown_location.latitude,a.hometown_location.longitude),title:a.name}),google.maps.event.addListener(a.hometown_location.marker,"click",function(a){return function(){infowindow.setContent(b(a)),infowindow.open(map,a.hometown_location.marker)}}(a))),(null==a.sex||""==a.sex)&&(a.sex="Doesn't say"),counts.sex[a.sex]||(counts.sex[a.sex]=0),counts.sex[a.sex]++,(null==a.relationship_status||""==a.relationship_status)&&(a.relationship_status="Doesn't say"),counts.relationship_status[a.relationship_status]||(counts.relationship_status[a.relationship_status]=0),counts.relationship_status[a.relationship_status]++,advanced_mode&&(addStringtoTaxonomy("Activities",a,"activities"),addStringtoTaxonomy("Books",a,"books"),addArraytoTaxonomy("School",a,"education","school.name"),addArraytoTaxonomy("Degree",a,"education","degree.name"),addArraytoTaxonomy("Inspirational People",a,"inspirational_people","name"),addStringtoTaxonomy("Interests",a,"interests"),addArraytoTaxonomy("Languages",a,"languages","name"),addArraytoTaxonomy("Meeting for",a,"meeting_for"),addArraytoTaxonomy("Meeting sex",a,"meeting_sex"),addStringtoTaxonomy("Movies",a,"movies"),addStringtoTaxonomy("Music",a,"music"),addStringtoTaxonomy("Political",a,"political"),addStringtoTaxonomy("Religion",a,"religion"),addArraytoTaxonomy("Sports",a,"sports","name"),addStringtoTaxonomy("TV",a,"tv"),addArraytoTaxonomy("Company",a,"work","employer.name"),addArraytoTaxonomy("Job Role",a,"work","position.name"));var d=$("#which_location option");$(d[0]).text("Current location - "+counts.locations.current_location),$(d[1]).text("Current Address - "+counts.locations.current_address),$(d[2]).text("Home town - "+counts.locations.hometown_location);var d=$("#sex");for(var e in counts.sex)$(d).append('<option value="'+e+'">'+e+" - "+counts.sex[e]+"</option>");var d=$("#status");for(var f in counts.relationship_status)$(d).append('<option value="'+f+'">'+f+" - "+counts.relationship_status[f]+"</option>");if(advanced_mode){console.log("taxonomy",counts);var d=$("#taxonomy>ul");counts.taxonomy_arrays={};for(var g in counts.taxonomy){counts.taxonomy_arrays[g]=[];for(var h in counts.taxonomy[g])counts.taxonomy_arrays[g].push({id:h,count:counts.taxonomy[g][h]});counts.taxonomy_arrays[g].sort(function(a,b){return"Doesn't say"==a.id&&"Doesn't say"!=b.id?-1:"Doesn't say"!=a.id&&"Doesn't say"==b.id?1:"Doesn't say"==a.id&&"Doesn't say"==b.id?0:a.count!=b.count?b.count-a.count:a.id<b.id?-1:a.id>b.id?1:0}),$(d).append('<li class="'+g.replace(/ /g,"_")+'"><span onclick="taxonomy_category_click(this);" class="title">'+g+'</span><span class="checklist"><ul></ul></span><ul>');for(var h in counts.taxonomy_arrays[g]){var i=counts.taxonomy_arrays[g][h];$(d).find("li."+g.replace(/ /g,"_")+">ul").append('<li><input type="checkbox" onclick="taxonomy_checkbox_click(this)" id="'+utf8_to_b64(g+"$%$"+i.id)+'" /><label for="'+utf8_to_b64(g+"$%$"+i.id)+'">'+i.id.trim()+" - "+i.count+"</label></li>")}}$(d).append("</ul></li>")}}function taxonomy_category_click(a){$(a).parent().toggleClass("open"),$("#taxonomy_filter").width($("#taxonomy").width()+$("#taxonomy_filter label").width())}function taxonomy_checkbox_click(a){var b=$(a).attr("id"),c=b64_to_utf8(b);taxonomy_values_checked[c]?(delete taxonomy_values_checked[c],$(a).parent().parent().parent().find(".checklist ul ."+b).remove()):(taxonomy_values_checked[c]=!0,$(a).parent().parent().parent().find(".checklist ul").append('<li class="'+b+'"><a href="#" onclick="taxonomy_checklist_click(\''+b+"');\">"+c.split("$%$")[1]+"</a></li")),map_update()}function taxonomy_checklist_click(a){var b=document.getElementById(a);return b.checked=!1,taxonomy_checkbox_click(b),!0}function map_update(){var b,a=$("#which_location").val();counts.hidden_friends=[];for(var c in data){friend=data[c],b=map;var d=$("#sex").val();"Any"!=d&&friend.sex!=d&&(b=null);var e=$("#status").val();"Any"!=e&&friend.relationship_status!=e&&(b=null);var f=$("#list").val();if("Any"!=f&&(friendsinfriendlists[f][friend.uid]||(b=null)),advanced_mode){var g=!1;for(var h in taxonomy_values_checked)if(taxonomy_values_checked.hasOwnProperty(h)){g=!0;break}if(g){var i=!1;for(t in taxonomy_values_checked){var j=mapTitlesToFields[t.split("$%$")[0].replace(/_/g," ")],k=t.split("$%$")[1];if("string"==j.type){if(friend[j.field_name].indexOf(k)>-1){i=!0;break}}else for(var l=friend[j.field_name],m=0;m<l.length;m++){if(j.sub_field)var n=getSubField(l[m],j.sub_field.split("."));else var n=l[m];if(n==k){i=!0;break}}}0==i&&(b=null)}}switch(a){case"current_location":friend.current_location?friend.current_location.marker.setMap(b):null!=b&&counts.hidden_friends.push(friend),friend.current_address&&friend.current_address.marker.setMap(null),friend.hometown_location&&friend.hometown_location.marker.setMap(null);break;case"current_address":friend.current_location&&friend.current_location.marker.setMap(null),friend.current_address?friend.current_address.marker.setMap(b):null!=b&&counts.hidden_friends.push(friend),friend.hometown_location&&friend.hometown_location.marker.setMap(null);break;case"hometown_location":friend.current_location&&friend.current_location.marker.setMap(null),friend.current_address&&friend.current_address.marker.setMap(null),friend.hometown_location?friend.hometown_location.marker.setMap(b):null!=b&&counts.hidden_friends.push(friend)}}$("#fake_select2 option:first-child").text(counts.hidden_friends.length+" friends not sharing their location on map"),$("#no_location li").remove();for(var m=0;m<counts.hidden_friends.length;m++)$("#no_location ul").append('<li><a href="'+counts.hidden_friends[m].profile_url+'" target="_blank">'+counts.hidden_friends[m].name+"</a></li>")}function advanced_mode_set(a,b){return window.atob?(advanced_mode=a,b?advanced_mode&&($("#advmode_enabled").show(),setTimeout(function(){$("#advmode_enabled").fadeOut()},2e3),fb_init_get_data(),map=new google.maps.Map(document.getElementById("map-canvas"),mapOptions)):$("#advmode").prop("checked",a),settings.set("advmode",advanced_mode),advanced_mode?($("#taxonomy_filter").show(),$("BODY").addClass("advanced_mode")):($("#taxonomy_filter").hide(),$("BODY").removeClass("advanced_mode")),void 0):(alert("sorry, your browser is not able to run advanced mode. please upgrade to the latest browser version"),void 0)}function toggle_taxonomy(){$("#taxonomy").is(":visible")?$("#taxonomy").hide():$("#taxonomy").show(),$("#taxonomy_filter").width($("#taxonomy").width()+$("#taxonomy_filter label").width())}function utf8_to_b64(a){var b=window.btoa(encodeURIComponent(escape(a)));return b.replace(/=/g,"_")}function b64_to_utf8(a){return unescape(decodeURIComponent(window.atob(a.replace(/_/g,"="))))}var uid,accessToken,basic_permissions={scope:"user_friends, user_hometown, user_location, friends_hometown, friends_location, friends_relationships, read_friendlists, friends_online_presence"},advanced_permissions={scope:"friends_activities, friends_about_me, friends_activities, friends_interests, friends_religion_politics, friends_work_history, friends_likes,  friends_relationship_details"},permissions={scope:basic_permissions.scope},taxonomy_values_checked={},advanced_mode;Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){null==b?b=0:0>b&&(b=Math.max(0,this.length+b));for(var c=b,d=this.length;d>c;c++)if(this[c]===a)return c;return-1}),settings={get:function(a,b){return window.localStorage?localStorage.getItem(a)?localStorage.getItem(a):"function"==typeof b?b():b:$.cookie(a)?$.cookie(a):"function"==typeof b?b():b},set:function(a,b){window.localStorage?localStorage.setItem(a,b):$.cookie(a,b,{path:"/"})}};
